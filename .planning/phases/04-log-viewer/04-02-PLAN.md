---
phase: 04-log-viewer
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/components/LogViewer.svelte
  - src/lib/components/InstanceCard.svelte
autonomous: false
must_haves:
  truths:
    - "User can view logs from selected container in embedded terminal view"
    - "System streams stdout from container in real-time"
    - "System streams stderr from container in real-time"
    - "User can watch logs update as container produces output"
    - "stdout and stderr are visually distinguishable"
  artifacts:
    - path: "src/lib/components/LogViewer.svelte"
      provides: "Log display with auto-scroll and stream controls"
      min_lines: 80
    - path: "src/lib/components/InstanceCard.svelte"
      provides: "View Logs button to open LogViewer"
      contains: "LogViewer"
  key_links:
    - from: "LogViewer.svelte"
      to: "stream_container_logs"
      via: "invoke with Channel"
      pattern: "invoke\\('stream_container_logs'"
    - from: "InstanceCard.svelte"
      to: "LogViewer.svelte"
      via: "component import and conditional render"
      pattern: "import.*LogViewer"
    - from: "LogViewer.svelte"
      to: "DOM"
      via: "$effect.pre with tick() for auto-scroll"
      pattern: "\\$effect\\.pre"
---

<objective>
Create the LogViewer component with real-time streaming, auto-scroll, and integrate it into InstanceCard with a "View Logs" button.

Purpose: Provide users a visual interface to view container logs in real-time.
Output: Working log viewer accessible from instance cards.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-log-viewer/04-RESEARCH.md

# Prior work
@.planning/phases/04-log-viewer/04-01-SUMMARY.md

# Existing patterns
@src/lib/components/InstanceCard.svelte
@src/lib/components/PullProgress.svelte
</context>

<tasks>

<task type="auto">
  <name>Create LogViewer component</name>
  <files>src/lib/components/LogViewer.svelte</files>
  <action>
Create `src/lib/components/LogViewer.svelte` following Svelte 5 patterns:

1. **Props interface**:
   ```typescript
   interface Props {
     containerName: string;
     tail?: number;
     onclose: () => void;
   }
   ```

2. **State using Svelte 5 runes**:
   - `logs` - array of {type: string, message: string}
   - `isStreaming` - boolean for live indicator
   - `error` - string for error display
   - `logContainer` - HTMLDivElement ref for auto-scroll

3. **Log streaming logic**:
   - Import `invoke` and `Channel` from `@tauri-apps/api/core`
   - Import `tick` from `svelte`
   - Create `startLogStream()` function:
     - Set isStreaming = true, clear logs/error
     - Create `new Channel<LogEvent>()`
     - Set `onLog.onmessage` handler to:
       - On Eof: set isStreaming = false
       - On Error: set error, isStreaming = false
       - On StdOut/StdErr: append to logs array
     - Call `invoke('stream_container_logs', {containerName, onLog, tail})`
   - Call startLogStream in $effect on mount (track containerName)

4. **Auto-scroll with $effect.pre**:
   ```svelte
   $effect.pre(() => {
     logs; // reactivity trigger
     tick().then(() => {
       if (logContainer) {
         const nearBottom = 
           logContainer.offsetHeight + logContainer.scrollTop > 
           logContainer.scrollHeight - 50;
         if (nearBottom) {
           logContainer.scrollTop = logContainer.scrollHeight;
         }
       }
     });
   });
   ```

5. **UI structure**:
   - Header with container name and live indicator (‚óè Live when streaming)
   - Scrollable log content area (max-height: 400px, overflow-y: auto)
   - Log lines with stderr class for red coloring
   - Error display if present
   - Close button that calls onclose

6. **Styling**:
   - Dark background (#1e1e1e) for terminal feel
   - Monospace font for log lines
   - StdErr in red (#ef4444)
   - StdOut in light gray (#d4d4d4)
   - Live indicator in green

DO NOT implement log filtering/search - not in requirements.
DO implement log line limit (keep last 5000 lines to prevent memory growth).
</action>
  <verify>
# Verify file exists
test -f src/lib/components/LogViewer.svelte && echo "File created"

# Check for required patterns
grep -q "Channel" src/lib/components/LogViewer.svelte && echo "Channel import found"
grep -q "stream_container_logs" src/lib/components/LogViewer.svelte && echo "Command invocation found"
grep -q "\\$effect.pre" src/lib/components/LogViewer.svelte && echo "Auto-scroll effect found"
grep -q "isStreaming" src/lib/components/LogViewer.svelte && echo "Streaming state found"

# Build frontend
npm run check 2>&1 | tail -10
</verify>
  <done>
- LogViewer.svelte exists with Channel-based streaming
- Auto-scroll implemented with $effect.pre + tick()
- stdout/stderr visually distinguishable (different colors)
- Live indicator when streaming
- Close button functional
</done>
</task>

<task type="auto">
  <name>Add View Logs button to InstanceCard</name>
  <files>src/lib/components/InstanceCard.svelte</files>
  <action>
Modify `src/lib/components/InstanceCard.svelte` to add log viewing capability:

1. **Add imports**:
   ```typescript
   import LogViewer from './LogViewer.svelte';
   ```

2. **Add state for log viewer**:
   ```typescript
   let showLogs = $state(false);
   ```

3. **Add Props for log callback** (optional, or handle inline):
   The existing onstart/onstop/etc pattern suggests keeping it simple - handle inline.

4. **Add View Logs button** in the UI:
   - Place near InstanceControls or in a new action row
   - Only show for running instances (status === 'running')
   - Button text: "View Logs"
   - On click: set showLogs = true

5. **Add LogViewer modal/overlay**:
   - Conditionally render LogViewer when showLogs is true
   - Pass containerName (format: "ldb-{instance.name}")
   - Pass onclose: () => showLogs = false
   - Style as overlay/modal (fixed position, z-index high)

6. **Modal styling**:
   ```css
   .log-modal {
     position: fixed;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background: rgba(0, 0, 0, 0.5);
     display: flex;
     align-items: center;
     justify-content: center;
     z-index: 1000;
   }
   ```

Container name format: "ldb-{instance.name.toLowerCase().replace(/\\s+/g, '-')}"
This matches the naming convention in instances.rs create_instance.
</action>
  <verify>
# Check for LogViewer import
grep -q "import LogViewer" src/lib/components/InstanceCard.svelte && echo "LogViewer imported"

# Check for showLogs state
grep -q "showLogs" src/lib/components/InstanceCard.svelte && echo "showLogs state found"

# Check for View Logs button
grep -q "View Logs" src/lib/components/InstanceCard.svelte && echo "Button found"

# Check for conditional LogViewer render
grep -q "LogViewer" src/lib/components/InstanceCard.svelte && echo "LogViewer usage found"

# Build frontend
npm run check 2>&1 | tail -10
</verify>
  <done>
- View Logs button visible for running instances
- Clicking opens LogViewer in modal overlay
- LogViewer receives correct container name
- Close button dismisses the modal
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete log viewer feature:
- Backend: stream_container_logs command in Rust
- Frontend: LogViewer.svelte component with real-time streaming
- Integration: View Logs button in InstanceCard
</what-built>
  <how-to-verify>
1. Start the app: `npm run tauri dev`
2. Create or start a database instance
3. Click "View Logs" button on a running instance
4. Verify:
   - Log viewer modal opens
   - Logs appear in the viewer
   - Live indicator shows when streaming
   - stderr lines appear in red
   - Auto-scroll works (scroll to bottom, verify new logs keep it there)
   - Close button dismisses the modal
5. Test with different database types (PostgreSQL, Redis, etc.)
</how-to-verify>
  <resume-signal>Type "approved" if working, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. LogViewer.svelte exists and imports Channel from Tauri
2. LogViewer calls stream_container_logs with correct parameters
3. Auto-scroll implemented with $effect.pre
4. InstanceCard has View Logs button for running instances
5. Modal overlay displays LogViewer correctly
6. Full app runs without errors
</verification>

<success_criteria>
- User can view logs from any running container
- Logs stream in real-time as container produces output
- stdout and stderr are visually distinguishable (different colors)
- Auto-scroll keeps user at bottom when near bottom
- Modal can be opened and closed
- Feature works with all database types
</success_criteria>

<output>
After completion, create `.planning/phases/04-log-viewer/04-02-SUMMARY.md`
</output>
